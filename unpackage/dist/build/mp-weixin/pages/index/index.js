"use strict";const e=require("../../common/vendor.js"),t=require("../../config.js"),s=require("../../common/unicloud-co-task.js"),i=require("./SliceMsgToLastMsg.js");let n=[];n.clear=function(){n.forEach((e=>e.abort())),n.slice(0,n.length)};const{adpid:o}=t.config;let a=!1;const l={components:{ZodiacAnimation:()=>"../../components/ZodiacAnimation.js",ZodiacBackground:()=>"../../components/ZodiacBackground.js"},data:()=>({scrollIntoView:"",msgList:[],requestState:0,insufficientScore:!1,userInfo:"",content:'参考用户个人信息和今日天气情况，生成一个今日指引，包括个人信息包括年龄（用户年龄给一个幽默的修饰词）、星座、天气情况、着装建议，谈事情的时间，感情、会客时间等等。让我心理更有依据和信息去完成每日的工作生活。输出内容不要写"玄学"二字。天气如下：',sseIndex:0,enableStream:!0,isWidescreen:!1,adpid:o,llmModel:!1,keyboardHeight:0,showZodiacAnimation:!0,animationType:"video",bgMusicPlaying:!0}),computed:{inputBoxDisabled(){return 0!==this.sseIndex||!(!this.msgList.length||this.msgList.length%2==0)},NODE_ENV:()=>"production",footBoxPaddingBottom(){return(this.keyboardHeight||10)+"px"}},watch:{msgList:{handler(t){e.index.setStorage({key:"uni-ai-msg",data:t})},deep:!0},insufficientScore(t){e.index.setStorage({key:"uni-ai-chat-insufficientScore",data:t})},llmModel(t){e.index.setStorage({key:"uni-ai-chat-llmModel",data:t})}},onShow:function(){console.log("检查是否首次进入");let t=e.index.getStorageSync("isFirstTime"),s=e.index.getStorageSync("hasPlayedOpeningVideo");if(e.index.getStorageSync("isNavigating"))return console.log("已有导航请求正在处理，跳过"),void e.index.removeStorageSync("isNavigating");t?s||(e.index.navigateTo({url:"/pages/opening/index",animationType:"none"}),e.index.setStorageSync("hasPlayedOpeningVideo",!0)):(console.log("跳转到个人信息"),e.index.setStorageSync("isNavigating",!0),setTimeout((()=>{e.index.reLaunch({url:"/pages/guide/guide",success:function(){console.log("成功跳转到guide页面")},fail:function(t){console.error("跳转失败:",t),e.index.showToast({title:"导航失败，已跳过新用户引导",icon:"none"});e.index.setStorageSync("userInfo",{nickname:"新用户",signature:"欢迎使用",birthYear:"1996",birthMonth:"11",birthDay:"3"}),e.index.setStorageSync("isFirstTime",!0)},complete:function(){e.index.removeStorageSync("isNavigating")}})}),300))},beforeMount(){},async mounted(){const t=e.index.getStorageSync("userInfo");t?(this.userInfo=t,console.log("获取到用户信息:",this.userInfo)):this.userInfo={birthMonth:6,birthDay:22};const s=e.index.getSystemInfoSync();this.animationType="android"===s.platform&&s.system.split(" ")[1]<9?"svg":"video";const i=await e.index.request({url:"https://restapi.amap.com/v3/weather/weatherInfo",method:"GET",data:{key:"bf987f744fd15fb566b0252c7f8f55c3",city:"440300",extensions:"base"}});if(1==i.data.status){const{data:t}=i;if(t.count>0){let s=function(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`};this.userInfo=e.index.getStorageSync("userInfo"),console.log("个人信息",this.userInfo);const i="姓名："+this.userInfo.nickname+"\n生日:"+this.userInfo.birthYear+"-"+this.userInfo.birthMonth+"-"+this.userInfo.birthDay+"\n星座:根据生日测算";let n=s(new Date);console.log(n),this.content=this.content+t.lives[0].city+"气温"+t.lives[0].temperature+t.lives[0].weather+"个人信息："+i+"\n今天日期:"+n}}if(this.beforeSend(),this.adpid&&e.nr.getCurrentUserInfo().tokenExpired>Date.now()){let t=e.nr.databaseForJQL(),s=await t.collection("uni-id-users").where({_id:e.nr.getCurrentUserInfo().uid}).field("score").get();console.log("当前用户有多少积分:",s.data[0]&&s.data[0].score)}this.msgList=e.index.getStorageSync("uni-ai-msg")||[],this.llmModel=e.index.getStorageSync("uni-ai-chat-llmModel"),this.insufficientScore=e.index.getStorageSync("uni-ai-chat-insufficientScore")||!1;let n=this.msgList.length;if(n){this.msgList[n-1].isAi||this.send()}this.$nextTick((()=>{this.showLastMsg()})),e.index.onKeyboardHeightChange((e=>{this.keyboardHeight=e.height,this.$nextTick((()=>{this.showLastMsg()}))}))},methods:{setLLMmodel(){this.$refs["llm-config"].open((e=>{console.log("model",e),this.llmModel=e}))},async checkIsOpenPush(){try{await e.index.getPushClientId(),this.checkIsOpenPush=()=>{}}catch(t){this.enableStream=!1}},updateLastMsg(e){let t=this.msgList.length;if(0===t)return;let s=this.msgList[t-1];if("function"==typeof e){e(s)}else{const[e,t=!1]=arguments;s=t?e:Object.assign(s,e)}this.msgList.splice(t-1,1,s)},onAdClose(t){if(console.log("onAdClose e.detail.isEnded",t.detail.isEnded),t.detail.isEnded){let t=0;e.index.showLoading({mask:!0});let s=setInterval((async i=>{t++;const n=e.nr.database();let o=await n.collection("uni-id-users").where('"_id" == $cloudEnv_uid').field("score").get(),{score:a}=o.result.data[0]||{};console.log("score",a),(a>0||t>5)&&(clearInterval(s),e.index.hideLoading(),a>0&&(this.insufficientScore=!1,this.msgList.pop(),this.$nextTick((()=>{this.send(),e.index.showToast({title:"积分余额:"+a,icon:"none"})}))))}),2e3)}},async changeAnswer(){this.sseIndex&&this.closeSseChannel(),this.msgList.pop(),this.updateLastMsg({illegal:!1}),this.insufficientScore=!1,this.send()},removeMsg(e){this.msgList[e].isAi&&(e-=1),this.sseIndex&&e==this.msgList.length-2&&this.closeSseChannel(),this.msgList.splice(e,2)},async beforeSend(){if(console.log("发送"),this.inputBoxDisabled)return e.index.showToast({title:"ai正在回复中不能发送",icon:"none"});if(this.adpid){if(!e.index.getStorageSync("uni_id_token"))return e.index.showModal({content:"启用激励视频，客户端需登录并启用安全网络",showCancel:!1,confirmText:"查看详情",complete(){e.index.setClipboardData({data:"https://uniapp.dcloud.net.cn/uniCloud/uni-ai-chat.html#ad",showToast:!1,success(){e.index.showToast({title:"已复制文档链接，请到浏览器粘贴浏览",icon:"none",duration:5e3})}})}})}if(!this.content)return e.index.showToast({title:"内容不能为空",icon:"none"});this.msgList.push({isAi:!1,content:this.content,create_time:Date.now()}),this.showLastMsg(),this.$nextTick((()=>{this.content=""})),this.send()},async send(){this.requestState=0,n.clear(),this.afterChatCompletion&&this.afterChatCompletion.clear&&this.afterChatCompletion.clear();let t,o,l=[],c=JSON.parse(JSON.stringify(this.msgList)),r=[...c].reverse().findIndex((e=>e.summarize));if(-1!=r){let e=c.length-r-1;c[e].content=c[e].summarize,c=c.splice(e)}else c=c.splice(-10);c=c.filter((e=>!e.illegal)),l=c.map((e=>{let t="user";return e.isAi&&(t=e.summarize?"system":"assistant"),{content:e.content,role:t}})),console.log("send to ai messages:",l),await this.checkIsOpenPush(),this.enableStream&&(a=new e.nr.SSEChannel,this.sliceMsgToLastMsg=new i.SliceMsgToLastMsg(this),a.on("message",(e=>{0===this.sseIndex?this.msgList.push({isAi:!0,content:e,create_time:Date.now()}):this.sliceMsgToLastMsg.addMsg(e),this.showLastMsg(),this.sseIndex++})),a.on("end",(e=>{if(console.log("sse 结束",e),this.sliceMsgToLastMsg.t=0,e&&"object"==typeof e&&e.errCode){let t=e=>{0===this.sseIndex?this.msgList.push({isAi:!0,content:e,create_time:Date.now()}):this.updateLastMsg((t=>{t.content+=e})),this.showLastMsg()};if(60004==e.errCode){let e=this.msgList.length;e%2&&(this.msgList.push({isAi:!0,content:"内容涉及敏感",illegal:!0,create_time:Date.now()}),e+=1),this.msgList[e-2].illegal=!0,this.msgList[e-1].illegal=!0,this.msgList[e-1].content="内容涉及敏感"}else t(e.errMsg)}t()})),await a.open(),function e(s){e.clear=()=>{e.clear.sse&&e.clear.sse(),e.clear.request&&e.clear.request()},Promise.all([new Promise(((s,i)=>{t=s,e.clear.sse=i})),new Promise(((t,s)=>{o=t,e.clear.request=s}))]).then((e=>{a.close(),s.sseIndex=0})).catch((e=>{})),s.afterChatCompletion=e}(this));let h=s.main({coName:"uni-ai-chat",funName:"send",param:[{messages:l,sseChannel:a,llmModel:this.llmModel}],config:{customUI:!0},success:e=>{if(this.requestState=100,!e.data)return;let{reply:t,summarize:s,insufficientScore:i,illegal:n}=e.data;if(0!=this.enableStream||t||(n=!0,t="内容涉及敏感"),0==this.enableStream&&n&&(console.error("内容涉及敏感"),this.updateLastMsg({illegal:!0})),(0==this.enableStream||0==this.sseIndex&&(n||i))&&this.msgList.push({create_time:Date.now(),isAi:!0,content:t,illegal:n}),i&&(this.insufficientScore=!0),s){console.log(" 拿到总结",s);let e=this.msgList.length-1;e-=e%2?2:1,e<1&&(e=1);let t=this.msgList[e];t.summarize=s,this.msgList.splice(e,1,t)}},complete:e=>{this.enableStream&&o(),this.$nextTick((()=>{this.showLastMsg()}))},fail:s=>{console.error(s),this.requestState=-100,e.index.showModal({content:JSON.stringify(s.message),showCancel:!1}),this.enableStream&&t()}});n.push(h)},closeSseChannel(){a&&(a.close(),a=!1,this.sliceMsgToLastMsg.end()),n.clear(),this.sseIndex=0},showLastMsg(){this.$nextTick((()=>{this.scrollIntoView="last-msg-item",this.$nextTick((()=>{this.scrollIntoView=""}))}))},clearAllMsg(t){e.index.showModal({title:"确认要清空聊天记录？",content:"本操作不可撤销",complete:e=>{e.confirm&&(this.closeSseChannel(),this.msgList.splice(0,this.msgList.length))}})},onAnimationComplete(){this.showZodiacAnimation=!1,this.loadPageContent()},loadPageContent(){console.log("页面内容加载完成")},toggleBackgroundMusic(){this.$refs.zodiacBackground&&this.$refs.zodiacBackground.toggleBackgroundMusic()}}};if(!Array){(e.resolveComponent("zodiac-animation")+e.resolveComponent("zodiac-background")+e.resolveComponent("uni-ai-msg")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-link"))()}Math||((()=>"../../components/uni-ai-msg/uni-ai-msg.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-link/components/uni-link/uni-link.js"))();const c=e._export_sfc(l,[["render",function(t,s,i,n,o,a){return e.e({a:o.showZodiacAnimation},o.showZodiacAnimation?{b:e.o(a.onAnimationComplete),c:e.p({"birth-month":o.userInfo.birthMonth||1,"birth-day":o.userInfo.birthDay||1,"animation-type":o.animationType,duration:7e3})}:{},{d:e.sr("zodiacBackground","013edfe2-1"),e:e.p({"birth-month":o.userInfo.birthMonth||1,"birth-day":o.userInfo.birthDay||1,"show-symbols":!0,"show-particles":!0,"show-background-video":!0,"play-background-music":o.bgMusicPlaying}),f:e.t(o.bgMusicPlaying?"暂停":"播放"),g:e.o(((...e)=>a.toggleBackgroundMusic&&a.toggleBackgroundMusic(...e))),h:0===o.msgList.length},(o.msgList.length,{}),{i:e.sr("msg","013edfe2-2"),j:e.p({msg:o.msgList[o.msgList.length-1]}),k:o.msgList.length%2!=0},o.msgList.length%2!=0?e.e({l:-100==o.requestState},-100==o.requestState?{m:e.o(a.send),n:e.p({color:"#d22",type:"refresh-filled"})}:o.msgList.length?e.e({p:"development"==a.NODE_ENV&&!o.enableStream},"development"!=a.NODE_ENV||o.enableStream?{}:{q:e.p({href:"https://uniapp.dcloud.net.cn/uniCloud/uni-ai-chat.html",text:"[流式响应]"})}):{},{o:o.msgList.length}):{},{r:o.adpid},(o.adpid,{}),{s:o.sseIndex},o.sseIndex?{t:e.o(((...e)=>a.closeSseChannel&&a.closeSseChannel(...e)))}:{},{v:o.scrollIntoView,w:o.msgList.length&&o.msgList.length%2!=0?"ai正在回复中不能发送":""})}]]);wx.createPage(c);
